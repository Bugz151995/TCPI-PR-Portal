@using System.ComponentModel.DataAnnotations;
@using Newtonsoft.Json;
@using TCPI_PR_Portal.Data;
@using TCPI_PR_Portal.Shared;
@using System.Text;
@using System.Security.Cryptography;
@using Blazor.SubtleCrypto;
@inject ICryptoService Crypto;
@inject ISnackbar Snackbar;
@inject HttpClient HttpClient;
@inject NavigationManager Navigation;
@inject Solutaris.InfoWARE.ProtectedBrowserStorage.Services.IIWLocalStorageService LocalStorage;

@page "/"

<EditForm Model="@User" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />

    <MudGrid Class="justify-center">
        <MudItem xs="12" sm="5">
            <MudCard Elevation="25" Class="pa-8">
                <div class="d-flex justify-center mb-10">
                    <MudImage ObjectFit="ObjectFit.Contain" Height="200" Width="400"
                              Src="420px-Taiheiyo_Cement_Logo.png" Alt="Taiheiyo Cement Logo" Class="rounded-lg" />
                </div>
                <MudCardContent>
                    <MudTextField Label="Username" HelperText="" @bind-Value="User.U_UserName"
                                  For="@(() => User.U_UserName)" Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Person" AdornmentColor="Color.Primary"
                                  Variant="Variant.Outlined" />
                    <MudTextField Label="Password" HelperText="" Class="mt-3" @bind-Value="User.U_Password"
                                  For="@(() => User.U_Password)" InputType="InputType.Password" Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Lock" AdornmentColor="Color.Primary"
                                  Variant="Variant.Outlined" />
                    <MudPaper Elevation="0" Class="d-flex justify-end">
                        <MudCheckBox T="bool" Label="Remember me" UnCheckedColor="Color.Primary"
                                     Color="Color.Primary" />
                    </MudPaper>
                </MudCardContent>
                <MudCardActions Class="justify-center pa-3">
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
                               Size="Size.Large">Login</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
</EditForm>

@code {
    LoginDto User = new LoginDto();

    bool success;

    protected override async void OnInitialized()
    {
        //hard coded config file for SAP B1 Connection
        var jsonCredential = JsonConvert.SerializeObject(new
        {
            CompanyDB = "TCPI_TESTDB",
            UserName = "manager",
            Password = "ftsi"
        });

        HttpContent content = new StringContent(jsonCredential, Encoding.UTF8, "application/json");

        using var sapLogin = await HttpClient.PostAsync("Login", content);


        if (!sapLogin.IsSuccessStatusCode)
            Snackbar.Add(sapLogin.ReasonPhrase, Severity.Error);


        await LocalStorage.SetItemAsync("SessionId", "testSession");
    }

    private async Task OnValidSubmit(EditContext context)
    {
        Console.WriteLine(await LocalStorage.GetItemAsync<string>("SessionId"));

        using var matchedRecord = await HttpClient.GetAsync($"U_FT_WPUS?$select=U_UserName,U_Password&$filter=U_UserName eq '{User.U_UserName}'");

        if (!matchedRecord.IsSuccessStatusCode)
        {
            Snackbar.Add(matchedRecord.ReasonPhrase, Severity.Error);
            return;
        }

        LoginResponse? response = await matchedRecord.Content.ReadFromJsonAsync<LoginResponse>();

        if(response != null)
        {
            try
            {
                // string password = await Crypto.DecryptAsync(response.value[0].U_Password);
                
                if (User.U_Password != response.value[0].U_Password)
                {
                    Snackbar.Add("The Password is incorrect!", Severity.Error);
                    return;
                }

                //save user to session
                Navigation.NavigateTo("user-setup");
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }

        success = true;
        StateHasChanged();
    }
}