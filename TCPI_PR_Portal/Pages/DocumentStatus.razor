@using System.Net.Http.Json;
@using Microsoft.AspNetCore.Authorization;
@using TCPI_PR_Portal.Shared;

@page "/document-status";
@attribute [Authorize];
@inject HttpClient HttpClient;
@inject NavigationManager Navigation;
@inject Solutaris.InfoWARE.ProtectedBrowserStorage.Services.IIWLocalStorageService LocalStorage;

<Title PageName="Document Status" Breadcrumb="_items" />

<MudTable Items="@PRRequests" T="PRHeaderDto" Dense="@dense" Hover="@hover" Bordered="@bordered" Striped="@striped" Filter="new Func<PRHeaderDto,bool>(FilterFunc1)" @bind-SelectedItem="selectedItem1">
    <ToolBarContent>
        <MudText Typo="Typo.h6">&nbsp;</MudText>
        <MudSpacer />
        <MudTextField Disabled="true" @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh></MudTh>
        <MudTh>#</MudTh>
        <MudTh style="white-space: nowrap!important;">Project ID</MudTh>
        <MudTh style="white-space: nowrap!important;">Project Name</MudTh>
        <MudTh style="white-space: nowrap!important;">Location</MudTh>
        <MudTh style="white-space: nowrap!important;">PR Type</MudTh>
        <MudTh style="white-space: nowrap!important;">Document Number</MudTh>
        <MudTh style="white-space: nowrap!important;">Department</MudTh>
        <MudTh style="white-space: nowrap!important;">Branch</MudTh>
        <MudTh style="white-space: nowrap!important;">Status</MudTh>
        <MudTh style="white-space: nowrap!important;">Document Date</MudTh>
        <MudTh style="white-space: nowrap!important;">Required Date</MudTh>
        <MudTh style="white-space: nowrap!important;">Urgency Priority</MudTh>
        <MudTh style="white-space: nowrap!important;">Prepared By</MudTh>
        <MudTh style="white-space: nowrap!important;">Reviewed By</MudTh>
        <MudTh style="white-space: nowrap!important;">Approved By (Level1)</MudTh>
        <MudTh style="white-space: nowrap!important;">Approved By (Level2)</MudTh>
        <MudTh style="white-space: nowrap!important;">Approved By (Level3)</MudTh>
        <MudTh style="white-space: nowrap!important;">Approved By (Level4)</MudTh>
        <MudTh style="white-space: nowrap!important;">Approved Date</MudTh>
        <MudTh style="white-space: nowrap!important;">Remarks</MudTh>
        <MudTh style="white-space: nowrap!important;">Approver Remarks</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>
            <MudIconButton Link="/document-status/approval" Icon="@Icons.Filled.RemoveRedEye" aria-label="View" Color="Color.Primary"></MudIconButton>
        </MudTd>
        <MudTd DataLabel="DocEntry">
            <MudTextField Disabled="true" @bind-Value="context.U_DocEntry" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Project ID">
            <MudTextField Disabled="true" @bind-Value="context.U_ProjectID" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Project Name">
            <MudTextField Disabled="true" @bind-Value="context.U_ProjName" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Location">
            <MudTextField Disabled="true" @bind-Value="context.U_Location" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="PR Type">
            <MudTextField Disabled="true" @bind-Value="context.U_PRType" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Document Number">
            <MudTextField Disabled="true" @bind-Value="context.U_DocNum" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Department">
            <MudTextField Disabled="true" @bind-Value="context.U_Department" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Branch">
            <MudTextField Disabled="true" @bind-Value="context.U_Branch" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Status">
            <MudTextField Disabled="true" @bind-Value="context.U_DocStatus" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Document Date">
            <MudTextField Disabled="true" @bind-Value="context.U_TaxDate" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Required Date">
            <MudTextField Disabled="true" @bind-Value="context.U_ReqDate" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Urgency Priority">
            <MudTextField Disabled="true" @bind-Value="context.U_Urgency" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Prepared By">
            <MudTextField Disabled="true" @bind-Value="context.U_PreparedBy" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Reviewed By">
            <MudTextField Disabled="true" @bind-Value="context.U_ReviewedBy" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Approved By (Level1)">
            <MudTextField Disabled="true" @bind-Value="context.U_ApprovedBy1" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Approved By (Level2)">
            <MudTextField Disabled="true" @bind-Value="context.U_ApprovedBy2" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Approved By (Level3)">
            <MudTextField Disabled="true" @bind-Value="context.U_ApprovedBy3" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Approved By (Level4)">
            <MudTextField Disabled="true" @bind-Value="context.U_ApprovedBy4" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Approved Date">
            <MudTextField Disabled="true" @bind-Value="context.U_ApprovedDate" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Remarks">
            <MudTextField Disabled="true" @bind-Value="context.U_Remarks" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
        <MudTd DataLabel="Approver Remarks">
            <MudTextField Disabled="true" @bind-Value="context.U_ApproverRemarks" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    // table settings
    private bool dense = false;
    private bool hover = true;
    private bool striped = false;
    private bool bordered = false;

    private List<BreadcrumbItem> _items = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Document Status", href: "document-status", disabled: true)
    };

    //// <summary>
    /// from here all logic are tests refactor later
    /// </summary>
    private string searchString = "";
    private PRHeaderDto selectedItem1 = null;

    private List<PRLinesDto> _lines = new List<PRLinesDto>();

    //test data
    private List<PRHeaderDto> PRRequests = new List<PRHeaderDto>();
    PRHeaderResponse? PRHeaderResponse = new PRHeaderResponse();

    // get method json ang makukua,
    protected override async Task OnInitializedAsync()
    {
        var userCode = LocalStorage.GetItem<string>("UserCode");
        using var response = await HttpClient.GetAsync($"U_FT_OPRQ?$filter=U_CardCode eq '{userCode}'");
        PRHeaderResponse = await response.Content.ReadFromJsonAsync<PRHeaderResponse>();
        PRRequests = PRHeaderResponse.value;
    }

    private bool FilterFunc1(PRHeaderDto element) => FilterFunc(element, searchString);

    private bool FilterFunc(PRHeaderDto element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.U_ProjectID.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.U_ProjName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    }
}